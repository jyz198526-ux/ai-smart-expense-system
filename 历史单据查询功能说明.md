# 🔍 AI智能申请单系统 - 历史单据查询功能

## 📋 功能概述

新增了员工历史单据查询功能，让AI可以智能地帮助用户查看和参考历史申请记录，并基于历史记录创建新的申请单。

## 🎯 核心特性

### ✅ 已实现功能

1. **智能历史查询**
   - 根据员工姓名查询历史已审批单据
   - 支持时间范围筛选
   - 支持记录数量限制（最大20条）

2. **丰富的显示信息**
   - 单据编号、标题、类型
   - 申请金额、项目信息
   - 描述、消费事由
   - 创建时间、审批状态
   - 单据类型统计

3. **AI智能识别**
   - 自动识别历史查询意图
   - 支持多种触发词汇
   - 强制工具调用机制

4. **用户友好界面**
   - HTML格式化显示
   - 表情符号状态标识
   - 清晰的分类统计

## 🚀 使用方法

### 触发历史查询的用户输入

用户可以通过以下任何表达方式触发历史单据查询：

```
• "查看历史单据"
• "历史记录"
• "参考历史记录"
• "我之前怎么填写的"
• "历史申请单"
• "根据历史单据新建"
• "帮我查下历史我怎么填写的"
```

### AI自动调用工具

当用户输入包含"历史"相关关键词时，AI会自动调用 `get_staff_history_documents` 工具。

## 🔧 技术实现

### 1. MCP接口 (`smart_expense_mcp.py`)

```python
async def get_staff_history_documents(self, staff_name: str = "金永志", count: int = 10, start_date: str = None, end_date: str = None) -> Dict[str, Any]:
    """根据员工姓名查询历史已审批单据"""
```

**核心功能：**
- 员工ID查找：通过姓名查找员工ID
- API调用：调用易快报历史单据查询API
- 数据处理：格式化单据信息和统计数据
- HTML生成：生成用户友好的显示格式

### 2. AI工具定义 (`services/deepseek_service.py`)

```python
{
    "type": "function",
    "function": {
        "name": "get_staff_history_documents",
        "description": "查询员工历史已审批单据，用于参考历史填写记录或根据历史单据创建新单据。",
        "parameters": {
            "type": "object",
            "properties": {
                "staff_name": {"type": "string", "description": "员工姓名，默认为'金永志'"},
                "count": {"type": "integer", "description": "返回记录数量，最大20条，默认10条"},
                "start_date": {"type": "string", "description": "查询开始时间，格式：yyyy-MM-dd HH:mm:ss"},
                "end_date": {"type": "string", "description": "查询结束时间，格式：yyyy-MM-dd HH:mm:ss"}
            },
            "required": []
        }
    }
}
```

### 3. 系统提示词增强

```
4. 用户说"历史"、"历史单据"、"历史记录"、"参考历史"、"根据历史" → 立即调用 get_staff_history_documents()
```

### 4. 前端显示支持

- 支持HTML格式显示历史单据
- 使用 `innerHTML` 渲染富文本内容
- 新增 `history_documents` 响应类型

## 📊 API接口详情

### 易快报API端点

```
GET /api/openapi/v1.1/docs/approved/{approverId}
```

**参数说明：**
- `approverId`: 员工ID（通过员工姓名查找获得）
- `accessToken`: 认证令牌
- `index`: 分页起始值（默认0）
- `count`: 查询条数（最大100，默认取10-20条）
- `startDate`: 查询开始时间（可选）
- `endDate`: 查询结束时间（可选）

## 🎨 显示效果

### 历史单据列表显示

```html
📋 员工 金永志 的历史申请单据
📊 总计 15 条记录，显示最近 10 条

📈 单据类型统计：
• 申请单: 8 条
• 报销单: 7 条

📝 历史单据详情：

1. ✅ 北京出差申请
📄 单据编号: S25000123
📋 单据类型: 申请单
💰 申请金额: 3000.00 元
🏢 项目: 客户调研
📝 描述: 前往北京进行重要客户拜访
🎯 消费事由: 商务出差
⏰ 创建时间: 2025-01-15 10:30:00

💡 使用提示：
• 输入 "根据历史单据新建" 可参考历史记录创建新申请单
• 输入具体的申请信息可直接创建新申请单
```

## 🔄 完整工作流程

### 场景1：查看历史记录

```
1. 用户输入："查看历史单据"
2. AI调用：get_staff_history_documents()
3. MCP查询：员工ID → API调用 → 数据格式化
4. 前端显示：HTML格式的历史单据列表
```

### 场景2：参考历史创建新单据

```
1. 用户输入："根据历史单据新建一个出差申请"
2. AI调用：get_staff_history_documents()
3. 用户查看历史记录，选择参考模板
4. 用户提供新的申请信息
5. AI调用：create_smart_expense() 创建新申请单
```

## 🎯 业务价值

1. **提升用户体验**
   - 减少重复填写
   - 提供历史参考
   - 智能化交互

2. **提高填写准确性**
   - 参考历史格式
   - 减少字段遗漏
   - 保持填写一致性

3. **增强系统智能性**
   - 上下文感知
   - 历史记录分析
   - 个性化建议

## 🧪 测试用例

### 基础查询测试

```
输入："查看历史单据"
预期：显示金永志的历史申请单据列表
```

### 参数化查询测试

```
输入："查看最近5条历史记录"
预期：AI应该调用工具并限制返回5条记录
```

### 时间范围查询测试

```
输入："查看2024年的历史申请"
预期：AI应该设置时间范围参数
```

### 基于历史创建测试

```
输入："根据历史单据新建一个培训申请"
预期：先显示历史记录，然后引导用户提供新信息
```

## 🔧 配置说明

### 环境变量

无需额外配置，使用现有的易快报API配置：

```
EK_APP_KEY=your_app_key
EK_APP_SECURITY=your_app_security
EK_BASE_URL=https://app.ekuaibao.com/api/openapi
```

### 默认设置

- 默认员工：金永志
- 默认查询条数：10条
- 最大查询条数：20条
- 显示条数：前10条（超出显示省略提示）

## 🚨 注意事项

1. **权限控制**
   - 只能查询已审批的单据
   - 基于员工ID的权限验证

2. **性能考虑**
   - 限制查询条数避免大量数据传输
   - 使用分页查询机制

3. **数据安全**
   - 通过认证令牌访问
   - 员工信息脱敏处理

4. **错误处理**
   - 员工不存在的处理
   - API调用失败的降级
   - 网络超时的重试机制

---

## 🎉 总结

历史单据查询功能成功集成到AI智能申请单系统中，实现了：

✅ **完整的查询能力** - 支持多维度历史单据查询  
✅ **智能的AI交互** - 自动识别用户意图并调用相应工具  
✅ **友好的显示界面** - HTML格式化显示，信息清晰易读  
✅ **灵活的参数支持** - 支持员工、时间、数量等参数定制  
✅ **完善的错误处理** - 多层次的异常处理和用户反馈  

这个功能极大地增强了系统的实用性和智能化水平，为用户提供了更加便捷和智能的申请单创建体验！



