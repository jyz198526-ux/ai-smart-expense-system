# AI智能申请单系统 - 部署指南

## 🎯 部署概述

本文档提供完整的生产环境部署指南，确保系统稳定运行。

## 🔧 服务器要求

### 最低配置
- CPU: 2核
- 内存: 4GB
- 存储: 20GB
- 网络: 稳定的互联网连接

### 推荐配置
- CPU: 4核
- 内存: 8GB
- 存储: 50GB SSD
- 网络: 1Gbps

## 📦 环境准备

### 1. Python环境
```bash
# 安装Python 3.11+
sudo apt update
sudo apt install python3.11 python3.11-pip python3.11-venv

# 创建虚拟环境
python3.11 -m venv ai_expense_env
source ai_expense_env/bin/activate
```

### 2. 系统依赖
```bash
# 安装系统依赖
sudo apt install -y curl git nginx supervisor
```

## 🚀 应用部署

### 1. 下载代码
```bash
# 克隆项目到服务器
git clone <repository_url> /opt/ai_expense_system
cd /opt/ai_expense_system

# 安装Python依赖
pip install -r requirements.txt
```

### 2. 配置环境变量
```bash
# 创建环境配置文件
cat > .env << EOF
# DeepSeek AI配置
DEEPSEEK_API_KEY=sk-43816199a7fd42f88e93b14358954b88
DEEPSEEK_API_URL=https://api.deepseek.com/chat/completions

# 易快报认证配置
EK_APP_KEY=b433ffa4-ff6e-4e76-95e6-1a7bed8777eb
EK_APP_SECURITY=60ec2aa6-6354-40b5-a742-0e1034962b2f
EK_BASE_URL=https://app.ekuaibao.com/api/openapi

# 生产环境配置
SERVER_HOST=127.0.0.1
SERVER_PORT=8000
LOG_LEVEL=INFO
EOF

# 设置文件权限
chmod 600 .env
```

### 3. 创建启动脚本
```bash
cat > start.sh << 'EOF'
#!/bin/bash
cd /opt/ai_expense_system
source ai_expense_env/bin/activate
python main.py
EOF

chmod +x start.sh
```

## 🔄 进程管理

### 使用Supervisor
```bash
# 安装supervisor配置
cat > /etc/supervisor/conf.d/ai_expense.conf << 'EOF'
[program:ai_expense]
command=/opt/ai_expense_system/ai_expense_env/bin/python main.py
directory=/opt/ai_expense_system
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/ai_expense.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
environment=PATH="/opt/ai_expense_system/ai_expense_env/bin"
EOF

# 重新加载配置并启动
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start ai_expense
```

## 🌐 Nginx配置

### 反向代理设置
```bash
cat > /etc/nginx/sites-available/ai_expense << 'EOF'
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态文件缓存
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 安全headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}
EOF

# 启用站点
sudo ln -s /etc/nginx/sites-available/ai_expense /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 🔒 SSL配置

### 使用Let's Encrypt
```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加：0 3 * * * certbot renew --quiet
```

## 📊 监控与日志

### 1. 日志配置
```bash
# 创建日志目录
sudo mkdir -p /var/log/ai_expense
sudo chown www-data:www-data /var/log/ai_expense

# 日志轮转配置
cat > /etc/logrotate.d/ai_expense << 'EOF'
/var/log/ai_expense/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        supervisorctl restart ai_expense
    endscript
}
EOF
```

### 2. 健康检查脚本
```bash
cat > /opt/ai_expense_system/health_check.sh << 'EOF'
#!/bin/bash

# 检查服务状态
response=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/health)

if [ "$response" = "200" ]; then
    echo "$(date): Service is healthy"
    exit 0
else
    echo "$(date): Service is unhealthy (HTTP $response)"
    # 重启服务
    supervisorctl restart ai_expense
    exit 1
fi
EOF

chmod +x /opt/ai_expense_system/health_check.sh

# 添加到crontab
echo "*/5 * * * * /opt/ai_expense_system/health_check.sh >> /var/log/ai_expense/health.log 2>&1" | sudo crontab -
```

## 🔧 性能优化

### 1. 系统调优
```bash
# 增加文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 网络优化
echo "net.core.somaxconn = 1024" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 2048" >> /etc/sysctl.conf
sudo sysctl -p
```

### 2. 应用配置
```bash
# 在main.py中添加workers配置
# uvicorn.run("main:app", host="127.0.0.1", port=8000, workers=4)
```

## 🛡️ 安全配置

### 1. 防火墙设置
```bash
# 配置UFW防火墙
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
```

### 2. 文件权限
```bash
# 设置正确的文件权限
sudo chown -R www-data:www-data /opt/ai_expense_system
sudo chmod -R 755 /opt/ai_expense_system
sudo chmod 600 /opt/ai_expense_system/.env
```

## 📋 部署检查清单

### 部署前检查
- [ ] 服务器配置满足要求
- [ ] Python环境安装完成
- [ ] 依赖包安装成功
- [ ] 环境变量配置正确
- [ ] API密钥有效

### 部署后验证
- [ ] 服务启动成功
- [ ] 健康检查通过
- [ ] 前端界面可访问
- [ ] AI对话功能正常
- [ ] 申请单创建成功
- [ ] 日志记录正常

### 监控项目
- [ ] CPU使用率 < 80%
- [ ] 内存使用率 < 80%
- [ ] 磁盘使用率 < 80%
- [ ] API响应时间 < 5s
- [ ] 错误率 < 1%

## 🚨 故障排除

### 常见问题

#### 1. 服务无法启动
```bash
# 检查日志
sudo tail -f /var/log/ai_expense.log

# 检查端口占用
sudo netstat -tlnp | grep 8000

# 手动启动调试
cd /opt/ai_expense_system
source ai_expense_env/bin/activate
python main.py
```

#### 2. API调用失败
```bash
# 检查网络连接
curl -I https://api.deepseek.com
curl -I https://app.ekuaibao.com

# 验证API密钥
curl -X POST "http://127.0.0.1:8000/api/test-auth"
```

#### 3. 内存泄漏
```bash
# 监控内存使用
ps aux | grep python
top -p $(pgrep -f main.py)

# 重启服务
sudo supervisorctl restart ai_expense
```

## 📞 技术支持

如遇到部署问题，请检查：
1. 系统日志：`/var/log/ai_expense.log`
2. 服务状态：`sudo supervisorctl status ai_expense`
3. 网络连接：测试API端点可达性
4. 配置文件：验证环境变量设置

---

*部署指南版本：v1.0*
*适用系统版本：AI智能申请单系统 v1.0*







