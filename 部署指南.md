# AIæ™ºèƒ½ç”³è¯·å•ç³»ç»Ÿ - éƒ¨ç½²æŒ‡å—

## ğŸ¯ éƒ¨ç½²æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚

## ğŸ”§ æœåŠ¡å™¨è¦æ±‚

### æœ€ä½é…ç½®
- CPU: 2æ ¸
- å†…å­˜: 4GB
- å­˜å‚¨: 20GB
- ç½‘ç»œ: ç¨³å®šçš„äº’è”ç½‘è¿æ¥

### æ¨èé…ç½®
- CPU: 4æ ¸
- å†…å­˜: 8GB
- å­˜å‚¨: 50GB SSD
- ç½‘ç»œ: 1Gbps

## ğŸ“¦ ç¯å¢ƒå‡†å¤‡

### 1. Pythonç¯å¢ƒ
```bash
# å®‰è£…Python 3.11+
sudo apt update
sudo apt install python3.11 python3.11-pip python3.11-venv

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.11 -m venv ai_expense_env
source ai_expense_env/bin/activate
```

### 2. ç³»ç»Ÿä¾èµ–
```bash
# å®‰è£…ç³»ç»Ÿä¾èµ–
sudo apt install -y curl git nginx supervisor
```

## ğŸš€ åº”ç”¨éƒ¨ç½²

### 1. ä¸‹è½½ä»£ç 
```bash
# å…‹éš†é¡¹ç›®åˆ°æœåŠ¡å™¨
git clone <repository_url> /opt/ai_expense_system
cd /opt/ai_expense_system

# å®‰è£…Pythonä¾èµ–
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡
```bash
# åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
cat > .env << EOF
# DeepSeek AIé…ç½®
DEEPSEEK_API_KEY=sk-43816199a7fd42f88e93b14358954b88
DEEPSEEK_API_URL=https://api.deepseek.com/chat/completions

# æ˜“å¿«æŠ¥è®¤è¯é…ç½®
EK_APP_KEY=b433ffa4-ff6e-4e76-95e6-1a7bed8777eb
EK_APP_SECURITY=60ec2aa6-6354-40b5-a742-0e1034962b2f
EK_BASE_URL=https://app.ekuaibao.com/api/openapi

# ç”Ÿäº§ç¯å¢ƒé…ç½®
SERVER_HOST=127.0.0.1
SERVER_PORT=8000
LOG_LEVEL=INFO
EOF

# è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 .env
```

### 3. åˆ›å»ºå¯åŠ¨è„šæœ¬
```bash
cat > start.sh << 'EOF'
#!/bin/bash
cd /opt/ai_expense_system
source ai_expense_env/bin/activate
python main.py
EOF

chmod +x start.sh
```

## ğŸ”„ è¿›ç¨‹ç®¡ç†

### ä½¿ç”¨Supervisor
```bash
# å®‰è£…supervisoré…ç½®
cat > /etc/supervisor/conf.d/ai_expense.conf << 'EOF'
[program:ai_expense]
command=/opt/ai_expense_system/ai_expense_env/bin/python main.py
directory=/opt/ai_expense_system
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/ai_expense.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
environment=PATH="/opt/ai_expense_system/ai_expense_env/bin"
EOF

# é‡æ–°åŠ è½½é…ç½®å¹¶å¯åŠ¨
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start ai_expense
```

## ğŸŒ Nginxé…ç½®

### åå‘ä»£ç†è®¾ç½®
```bash
cat > /etc/nginx/sites-available/ai_expense << 'EOF'
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketæ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # å®‰å…¨headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}
EOF

# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/ai_expense /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## ğŸ”’ SSLé…ç½®

### ä½¿ç”¨Let's Encrypt
```bash
# å®‰è£…certbot
sudo apt install certbot python3-certbot-nginx

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ï¼š0 3 * * * certbot renew --quiet
```

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### 1. æ—¥å¿—é…ç½®
```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/ai_expense
sudo chown www-data:www-data /var/log/ai_expense

# æ—¥å¿—è½®è½¬é…ç½®
cat > /etc/logrotate.d/ai_expense << 'EOF'
/var/log/ai_expense/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        supervisorctl restart ai_expense
    endscript
}
EOF
```

### 2. å¥åº·æ£€æŸ¥è„šæœ¬
```bash
cat > /opt/ai_expense_system/health_check.sh << 'EOF'
#!/bin/bash

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
response=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/health)

if [ "$response" = "200" ]; then
    echo "$(date): Service is healthy"
    exit 0
else
    echo "$(date): Service is unhealthy (HTTP $response)"
    # é‡å¯æœåŠ¡
    supervisorctl restart ai_expense
    exit 1
fi
EOF

chmod +x /opt/ai_expense_system/health_check.sh

# æ·»åŠ åˆ°crontab
echo "*/5 * * * * /opt/ai_expense_system/health_check.sh >> /var/log/ai_expense/health.log 2>&1" | sudo crontab -
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### 1. ç³»ç»Ÿè°ƒä¼˜
```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# ç½‘ç»œä¼˜åŒ–
echo "net.core.somaxconn = 1024" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 2048" >> /etc/sysctl.conf
sudo sysctl -p
```

### 2. åº”ç”¨é…ç½®
```bash
# åœ¨main.pyä¸­æ·»åŠ workersé…ç½®
# uvicorn.run("main:app", host="127.0.0.1", port=8000, workers=4)
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™è®¾ç½®
```bash
# é…ç½®UFWé˜²ç«å¢™
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
```

### 2. æ–‡ä»¶æƒé™
```bash
# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
sudo chown -R www-data:www-data /opt/ai_expense_system
sudo chmod -R 755 /opt/ai_expense_system
sudo chmod 600 /opt/ai_expense_system/.env
```

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] æœåŠ¡å™¨é…ç½®æ»¡è¶³è¦æ±‚
- [ ] Pythonç¯å¢ƒå®‰è£…å®Œæˆ
- [ ] ä¾èµ–åŒ…å®‰è£…æˆåŠŸ
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] APIå¯†é’¥æœ‰æ•ˆ

### éƒ¨ç½²åéªŒè¯
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] å‰ç«¯ç•Œé¢å¯è®¿é—®
- [ ] AIå¯¹è¯åŠŸèƒ½æ­£å¸¸
- [ ] ç”³è¯·å•åˆ›å»ºæˆåŠŸ
- [ ] æ—¥å¿—è®°å½•æ­£å¸¸

### ç›‘æ§é¡¹ç›®
- [ ] CPUä½¿ç”¨ç‡ < 80%
- [ ] å†…å­˜ä½¿ç”¨ç‡ < 80%
- [ ] ç£ç›˜ä½¿ç”¨ç‡ < 80%
- [ ] APIå“åº”æ—¶é—´ < 5s
- [ ] é”™è¯¯ç‡ < 1%

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æ£€æŸ¥æ—¥å¿—
sudo tail -f /var/log/ai_expense.log

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 8000

# æ‰‹åŠ¨å¯åŠ¨è°ƒè¯•
cd /opt/ai_expense_system
source ai_expense_env/bin/activate
python main.py
```

#### 2. APIè°ƒç”¨å¤±è´¥
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
curl -I https://api.deepseek.com
curl -I https://app.ekuaibao.com

# éªŒè¯APIå¯†é’¥
curl -X POST "http://127.0.0.1:8000/api/test-auth"
```

#### 3. å†…å­˜æ³„æ¼
```bash
# ç›‘æ§å†…å­˜ä½¿ç”¨
ps aux | grep python
top -p $(pgrep -f main.py)

# é‡å¯æœåŠ¡
sudo supervisorctl restart ai_expense
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç³»ç»Ÿæ—¥å¿—ï¼š`/var/log/ai_expense.log`
2. æœåŠ¡çŠ¶æ€ï¼š`sudo supervisorctl status ai_expense`
3. ç½‘ç»œè¿æ¥ï¼šæµ‹è¯•APIç«¯ç‚¹å¯è¾¾æ€§
4. é…ç½®æ–‡ä»¶ï¼šéªŒè¯ç¯å¢ƒå˜é‡è®¾ç½®

---

*éƒ¨ç½²æŒ‡å—ç‰ˆæœ¬ï¼šv1.0*
*é€‚ç”¨ç³»ç»Ÿç‰ˆæœ¬ï¼šAIæ™ºèƒ½ç”³è¯·å•ç³»ç»Ÿ v1.0*







